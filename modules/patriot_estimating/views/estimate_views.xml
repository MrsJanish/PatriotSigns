<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Estimate Tree View -->
    <record id="ps_estimate_tree" model="ir.ui.view">
        <field name="name">ps.estimate.tree</field>
        <field name="model">ps.estimate</field>
        <field name="arch" type="xml">
            <list decoration-success="state == 'won'"
                  decoration-muted="state == 'lost'">
                <field name="name"/>
                <field name="opportunity_id"/>
                <field name="gc_partner_id"/>
                <field name="date"/>
                <field name="total" sum="Total"/>
                <field name="state" widget="badge"/>
            </list>
        </field>
    </record>

    <!-- Estimate Form View -->
    <record id="ps_estimate_form" model="ir.ui.view">
        <field name="name">ps.estimate.form</field>
        <field name="model">ps.estimate</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="action_populate_from_sign_types" 
                            string="Populate from Sign Types" 
                            type="object"
                            class="btn-secondary"
                            invisible="state != 'draft'"/>
                    <button name="action_approve" 
                            string="Approve" 
                            type="object"
                            class="btn-primary"
                            invisible="state != 'draft'"/>
                    <button name="action_submit" 
                            string="Submit" 
                            type="object"
                            class="btn-success"
                            invisible="state != 'approved'"/>
                    <field name="state" widget="statusbar"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <label for="name"/>
                        <h1>
                            <field name="name"/>
                        </h1>
                        <h3>
                            <field name="project_name" readonly="1"/>
                        </h3>
                    </div>
                    <group>
                        <group string="Project">
                            <field name="opportunity_id"/>
                            <field name="gc_partner_id"/>
                        </group>
                        <group string="Dates">
                            <field name="date"/>
                            <field name="valid_until"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Estimate Lines" name="lines">
                            <field name="line_ids" mode="list">
                                <list>
                                    <field name="sequence" widget="handle"/>
                                    <field name="sign_type_id"/>
                                    <field name="description"/>
                                    <field name="category_id" optional="show"/>
                                    <field name="dimensions_display" optional="show"/>
                                    <field name="sign_width" optional="hide"/>
                                    <field name="sign_height" optional="hide"/>
                                    <field name="quantity"/>
                                    <field name="material_unit_cost"/>
                                    <field name="material_extended" sum="Material"/>
                                    <field name="labor_hours" optional="show"/>
                                    <field name="labor_rate" optional="hide"/>
                                    <field name="labor_extended" sum="Labor"/>
                                    <field name="breakeven_price" string="Break-Even/Unit" optional="show"/>
                                    <field name="unit_price" string="Sell/Unit"/>
                                    <field name="breakeven_extended" string="Break-Even Total" sum="Break-Even"/>
                                    <field name="line_total" sum="Sell Total"/>
                                    <field name="profit_amount" string="Profit $" sum="Profit"/>
                                </list>
                                <form>
                                    <sheet>
                                        <group>
                                            <group string="Sign Type">
                                                <field name="sign_type_id"
                                                       context="{'default_opportunity_id': parent.opportunity_id}"
                                                       domain="[('opportunity_id', '=', parent.opportunity_id)]"/>
                                                <field name="description"/>
                                                <field name="category_id"/>
                                            </group>
                                            <group string="Dimensions">
                                                <field name="sign_width"/>
                                                <field name="sign_height"/>
                                                <field name="dimensions_display" readonly="1"/>
                                            </group>
                                        </group>
                                        <group>
                                            <group string="Quantity &amp; Pricing">
                                                <field name="quantity"/>
                                                <field name="unit_price"/>
                                                <field name="material_unit_cost"/>
                                                <field name="total_unit_cost" readonly="1"/>
                                                <field name="breakeven_price" readonly="1"/>
                                            </group>
                                            <group string="Costs">
                                                <field name="material_extended" readonly="1"/>
                                                <field name="labor_hours" readonly="1"/>
                                                <field name="labor_extended" readonly="1"/>
                                                <field name="profit_margin" readonly="1"/>
                                                <field name="line_total" readonly="1"/>
                                            </group>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                        </page>
                        
                        <page string="Labor &amp; Travel" name="labor_travel">
                            <group>
                                <group string="Shop Labor (Mold-Based)">
                                    <field name="total_molds" readonly="1"/>
                                    <field name="mold_time_minutes"/>
                                    <field name="shop_rate"/>
                                    <field name="shop_labor_total" widget="monetary" readonly="1"/>
                                </group>
                                <group string="Travel">
                                    <field name="travel_miles"/>
                                    <field name="travel_rate"/>
                                    <field name="travel_trips"/>
                                    <field name="travel_total" widget="monetary" readonly="1"/>
                                </group>
                            </group>
                        </page>
                        
                        <page string="Installation" name="installation">
                            <group>
                                <group string="Install Crew">
                                    <field name="install_crew_id" options="{'no_create': False}"/>
                                    <field name="install_crew_size" readonly="1"/>
                                    <field name="install_rate"/>
                                </group>
                                <group string="Install Labor">
                                    <field name="install_hours"/>
                                    <field name="install_total" widget="monetary" readonly="1"/>
                                </group>
                            </group>
                            <group>
                                <group string="Equipment Rental">
                                    <field name="needs_equipment"/>
                                    <field name="equipment_type" invisible="not needs_equipment"/>
                                    <field name="equipment_days" invisible="not needs_equipment"/>
                                    <field name="equipment_daily_rate" invisible="not needs_equipment"/>
                                    <field name="equipment_delivery" invisible="not needs_equipment"/>
                                    <field name="equipment_total" widget="monetary" readonly="1" invisible="not needs_equipment"/>
                                </group>
                            </group>
                        </page>
                        
                        <page string="Summary" name="summary">
                            <group class="oe_subtotal_footer oe_right">
                                <field name="signage_total" widget="monetary" readonly="1" string="Signage Total"/>
                                <field name="travel_total" widget="monetary" readonly="1" string="Travel"/>
                                <field name="install_total" widget="monetary" readonly="1" string="Installation"/>
                                <field name="equipment_total" widget="monetary" readonly="1" invisible="not needs_equipment" string="Equipment"/>
                                <field name="total" widget="monetary" readonly="1" class="oe_subtotal_footer_separator" string="Estimate Total"/>
                            </group>
                            <div class="oe_clear"/>
                            <button name="action_generate_quotation" type="object"
                                    string="âš¡ Generate Quotation" class="btn-primary"
                                    invisible="state not in ['approved', 'submitted']"
                                    confirm="Create a quotation from this estimate? Each line becomes a quotation line item with the bid prices."/>
                        </page>
                        
                        <page string="Terms" name="terms">
                            <group>
                                <field name="terms"/>
                                <field name="exclusions"/>
                            </group>
                        </page>
                        
                        <page string="Notes" name="notes">
                            <field name="notes"/>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Estimate Line Form View (used when clicking a line from any context) -->
    <record id="ps_estimate_line_form" model="ir.ui.view">
        <field name="name">ps.estimate.line.form</field>
        <field name="model">ps.estimate.line</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <field name="estimate_id" invisible="1"/>
                    <!-- Intermediate computed fields for auto-refresh dependency chain -->
                    <field name="signs_per_mold" invisible="1"/>
                    <field name="molds_needed" invisible="1"/>
                    <field name="signs_produced" invisible="1"/>
                    <field name="stock_generated" invisible="1"/>
                    <field name="sheets_needed" invisible="1"/>
                    <field name="waste_percent" invisible="1"/>
                    <field name="labor_unit_cost" invisible="1"/>
                    <field name="overhead_unit_cost" invisible="1"/>
                    <field name="calculate_dynamic" invisible="1"/>
                    <group>
                        <group string="Sign Type">
                            <field name="sign_type_id"
                                   domain="[('opportunity_id', '=', estimate_id.opportunity_id)]"/>
                            <field name="description"/>
                            <field name="category_id"/>
                        </group>
                        <group string="Dimensions">
                            <field name="sign_width"/>
                            <field name="sign_height"/>
                            <field name="dimensions_display" readonly="1"/>
                        </group>
                    </group>
                    <group>
                        <group string="Quantity &amp; Pricing">
                            <field name="quantity"/>
                            <field name="unit_price"/>
                            <field name="material_unit_cost"/>
                            <field name="total_unit_cost" readonly="1"/>
                            <field name="breakeven_price" readonly="1"/>
                        </group>
                        <group string="Costs">
                            <field name="material_extended" readonly="1"/>
                            <field name="labor_hours" readonly="1"/>
                            <field name="labor_extended" readonly="1"/>
                            <field name="profit_margin" readonly="1"/>
                            <field name="line_total" readonly="1"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Estimate Action -->
    <record id="ps_estimate_action" model="ir.actions.act_window">
        <field name="name">Estimates</field>
        <field name="res_model">ps.estimate</field>
        <field name="view_mode">list,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first estimate
            </p>
            <p>
                Estimates are created from CRM opportunities and contain
                detailed cost breakdowns for each sign type.
            </p>
        </field>
    </record>

    <!-- Estimate Line Graph View (For Analysis) -->
    <record id="ps_estimate_line_graph" model="ir.ui.view">
        <field name="name">ps.estimate.line.graph</field>
        <field name="model">ps.estimate.line</field>
        <field name="arch" type="xml">
            <graph string="Estimate Analysis" type="bar">
                <field name="estimate_id"/>
                <field name="waste_percent" type="measure"/>
                <field name="profit_margin" type="measure"/>
            </graph>
        </field>
    </record>

    <!-- Estimate Line Pivot View (For Analysis) -->
    <record id="ps_estimate_line_pivot" model="ir.ui.view">
        <field name="name">ps.estimate.line.pivot</field>
        <field name="model">ps.estimate.line</field>
        <field name="arch" type="xml">
            <pivot string="Estimate Analysis">
                <field name="estimate_id" type="row"/>
                <field name="category_id" type="col"/>
                <field name="quantity" type="measure"/>
                <field name="waste_percent" type="measure"/>
                <field name="profit_margin" type="measure"/>
                <field name="line_total" type="measure"/>
            </pivot>
        </field>
    </record>

    <!-- Estimate Analysis Action -->
    <record id="ps_estimate_analysis_action" model="ir.actions.act_window">
        <field name="name">Estimate &amp; Waste Analysis</field>
        <field name="res_model">ps.estimate.line</field>
        <field name="view_mode">graph,pivot,list</field>
        <field name="context">{'search_default_group_by_estimate': 1}</field>
    </record>

</odoo>
